# Operations

## Observability

The delivery service exposes baseline observability for external ops tooling:

- **Structured JSON logs** for API and domain actions.
- **Request IDs** (`X-Request-ID`) accepted from callers or generated by API.
- **Metrics endpoint** at `GET /metrics` (OPS/ADMIN auth required).

### Structured log fields

All service logs include these fields for correlation:

- `request_id`
- `order_id`
- `job_id`
- `drone_id`

Additional standard fields include `timestamp`, `level`, `logger`, and `message`.

### Request IDs

Clients can send an `X-Request-ID` header on any request. The API echoes it back in the response header.
If no request ID is supplied, the API generates one.

### Metrics

`GET /metrics` returns JSON with two sections:

- `counters` (e.g. `http_requests_total`)
- `timings` (aggregated timing stats with `count`, `avg_s`, `max_s`)

Timing metrics currently captured:

- `dispatch_assignment_seconds`
- `mission_intent_generation_seconds`
- `http_request_duration_seconds`

## Integration boundaries and retries

External integration clients now enforce explicit retry/backoff limits and return structured domain errors:

- `fleet_api_client`
  - timeout via `FLEET_API_TIMEOUT_S`
  - retries via `FLEET_API_MAX_RETRIES`
  - exponential backoff base via `FLEET_API_BACKOFF_S`
- `gcs_bridge_client`
  - optional HTTP bridge URL via `GCS_BRIDGE_BASE_URL` (empty means no-op publisher)
  - timeout via `GCS_BRIDGE_TIMEOUT_S`
  - retries via `GCS_BRIDGE_MAX_RETRIES`
  - exponential backoff base via `GCS_BRIDGE_BACKOFF_S`

Error translation for API callers:
- retryable integration failures translate to `503 Service Unavailable`
- non-retryable upstream response failures translate to `502 Bad Gateway`
- response body includes `{service, code, message}` for debugging and runbook routing.

## Database configuration

Set `WINGXTRA_DATABASE_URL` to configure the SQLAlchemy connection URL.
For CI and local test safety, the service defaults to `sqlite+pysqlite:///./test.db` when unset.

Set `WINGXTRA_TESTING=true` in test environments to disable startup demo-data seeding.
This keeps API list endpoints deterministic for integration tests. During pytest runs, seeding is also automatically disabled when `PYTEST_CURRENT_TEST` is present.

In test mode (`WINGXTRA_TESTING=true` or pytest runtime), placeholder order IDs `ord-1` and `ord-2` are accepted for UI integration tests and are materialized as in-memory stub orders.

## Delivery readiness checklist

Run this checklist before promoting a release candidate:

- [ ] **Postgres-backed readiness suite passes in CI**
  - Command: `pytest tests/integration/test_readiness_layer.py`
  - Pass criteria: all readiness tests pass against Postgres with `WINGXTRA_TESTING=true`.
- [ ] **Happy-path workflow validated end to end**
  - Scenario: order creation → assignment → mission submit → delivery event progression (`LAUNCHED`, `ENROUTE`, `DELIVERED`) → POD creation → public tracking lookup.
  - Pass criteria: timeline contains expected ordered events and tracking returns `DELIVERED` + POD summary.
- [ ] **Failure paths validated**
  - Scenario coverage: unavailable drone, low-battery drone, duplicate mission submit (idempotency key replay), and external publish failure.
  - Pass criteria: API returns deterministic error responses for assignment failures, duplicate mission submit publishes once, and publish failure is surfaced while preserving persisted mission state for operator recovery.
- [ ] **Hot endpoint smoke checks complete**
  - Scenario coverage: `/api/v1/orders`, `/api/v1/tracking/{id}`, and `/api/v1/dispatch/run` under short burst load.
  - Pass criteria: request bursts complete within guardrail timings asserted by readiness tests and dispatch assigns all eligible queued orders.
