# Operations

## Observability

The delivery service exposes baseline observability for external ops tooling:

- **Structured JSON logs** for API and domain actions.
- **Request IDs** (`X-Request-ID`) accepted from callers or generated by API.
- **Readiness endpoint** at `GET /ready` (includes dependency checks).
- **Metrics endpoint** at `GET /metrics` (OPS/ADMIN auth required).

### Structured log fields

All service logs include these fields for correlation:

- `request_id`
- `order_id`
- `job_id`
- `drone_id`

Additional standard fields include `timestamp`, `level`, `logger`, and `message`.

### Request IDs

Clients can send an `X-Request-ID` header on any request. The API echoes it back in the response header.
If no request ID is supplied, the API generates one.

### Readiness

`GET /ready` returns dependency-level readiness for deploy/load-balancer probes.
It responds with HTTP `200` when all dependencies are healthy and HTTP `503` when any dependency is degraded.

Current checks:

- `database` (runs `SELECT 1`)
- `redis` (optional; checked only when `REDIS_URL` is configured)

Readiness config env vars:
- `REDIS_URL` (optional; enables Redis dependency check in `/ready` when set, must use `redis://`)
- `REDIS_READINESS_TIMEOUT_S` (optional; timeout in seconds for Redis readiness connection/ping, default `1.0`)

Redis readiness check behavior:

- Supports `redis://` URLs.
- Opens a short-lived TCP connection and performs a Redis `PING`/`PONG` check.
- Reports `error` when URL is invalid/unset for scheme expectations, connection fails, or ping is unsuccessful.
- Any unexpected dependency checker status is coerced to `error` (fail-closed) and logged for diagnostics.

Response shape:
- `status`: `ok` or `degraded`
- `dependencies`: list of `{name, status}` entries

### Metrics

`GET /metrics` returns JSON with two sections:

Test harness behavior: API tests reset in-memory counters/timings between tests to prevent metrics leakage across test cases.

- `counters` (e.g. `http_requests_total`)
- `timings` (aggregated timing stats with `count`, `avg_s`, `max_s`)

Counter metrics currently captured include:

- `http_requests_total`
- `idempotency_store_total`
- `idempotency_replay_total`
- `idempotency_conflict_total`
- `idempotency_invalid_key_total`
- `idempotency_purged_total`
- `rate_limit_checked_total`
- `rate_limit_rejected_total`
- `readiness_dependency_checked_total`
- `readiness_dependency_error_total`
- `dispatch_run_total`

Timing metrics currently captured:

- `dispatch_run_seconds`
- `dispatch_assignment_seconds`
- `mission_intent_generation_seconds`
- `http_request_duration_seconds`

## Integration boundaries and retries

External integration clients now enforce explicit retry/backoff limits and return structured domain errors:

- `fleet_api_client`
  - base URL via `FLEET_API_BASE_URL` (required for dispatch/assignment that query telemetry)
  - timeout via `FLEET_API_TIMEOUT_S`
  - retries via `FLEET_API_MAX_RETRIES`
  - exponential backoff base via `FLEET_API_BACKOFF_S`
- `gcs_bridge_client`
  - optional HTTP bridge URL via `GCS_BRIDGE_BASE_URL` (empty means no-op publisher)
  - timeout via `GCS_BRIDGE_TIMEOUT_S`
  - retries via `GCS_BRIDGE_MAX_RETRIES`
  - exponential backoff base via `GCS_BRIDGE_BACKOFF_S`

Error translation for API callers:
- retryable integration failures translate to `503 Service Unavailable`
- non-retryable upstream response failures translate to `502 Bad Gateway`
- response body includes `{service, code, message}` for debugging and runbook routing.

## Database configuration

Set `WINGXTRA_DATABASE_URL` to configure the SQLAlchemy connection URL.
For CI and local test safety, the service defaults to `sqlite+pysqlite:///./test.db` when unset.

CI now runs API tests against Postgres (service container in `.github/workflows/api.yml`) to improve environment parity with production.
SQLite remains supported for local/dev safety when `WINGXTRA_DATABASE_URL` is unset.
In non-test runtime (`WINGXTRA_TESTING=false`), startup fails fast when `WINGXTRA_DATABASE_URL` uses SQLite; use Postgres in production-like deployments.

Set `WINGXTRA_TESTING=true` in test environments to disable startup demo-data seeding.
This keeps API list endpoints deterministic for integration tests.

Set `WINGXTRA_UI_SERVICE_MODE` to select the UI service strategy:

- `auto` (default): resolves to `hybrid` when `WINGXTRA_TESTING=true`, otherwise `db`.
- `db`: only database-backed order and tracking flows.
- `store`: only in-memory placeholder/test flows (test/dev only).
- `hybrid`: DB-backed API flows with placeholder/store adapters enabled for UI test IDs like `ord-1` and `ord-2` (test/dev only).

In non-test runtime (`WINGXTRA_TESTING=false`), startup fails fast unless the resolved mode is `db` (for example: `db` or `auto`).
Invalid `WINGXTRA_UI_SERVICE_MODE` values are rejected during settings validation at startup.
Values are normalized case-insensitively (for example, `HYBRID` resolves to `hybrid`).


## Local infrastructure (Docker Compose)

`docker-compose.yml` now provisions both:

- `postgres` (primary API datastore)
- `redis` (available for local background queues, idempotency/rate-limit backends, and caching as hardening evolves)

Example start command:

```bash
docker compose up -d
```


## Dispatch worker

`workers/dispatch_worker/worker.py` can run periodic auto-dispatch ticks against the API (`POST /api/v1/dispatch/run`).
Invalid JSON in dispatch worker responses is treated as a failed tick (to avoid false-positive success accounting).

Environment variables:

- `WINGXTRA_DISPATCH_WORKER_API_BASE_URL` (default `http://localhost:8000`)
- `WINGXTRA_DISPATCH_WORKER_AUTH_TOKEN` (optional bearer token; required when dispatch endpoint auth is enabled)
- `WINGXTRA_DISPATCH_WORKER_INTERVAL_S` (default `10`)
- `WINGXTRA_DISPATCH_WORKER_TIMEOUT_S` (default `5`)
- `WINGXTRA_DISPATCH_WORKER_MAX_ASSIGNMENTS` (optional, integer >= 1)
- `WINGXTRA_DISPATCH_WORKER_MAX_RETRIES` (default `2`; retries retryable failures such as network errors and HTTP `408`/`429`/`5xx`)
- `WINGXTRA_DISPATCH_WORKER_RETRY_BACKOFF_S` (default `0.5`; exponential base delay)

Example:

```bash
WINGXTRA_DISPATCH_WORKER_API_BASE_URL=http://localhost:8000 \
WINGXTRA_DISPATCH_WORKER_AUTH_TOKEN=<ops-jwt> \
python workers/dispatch_worker/worker.py
```
